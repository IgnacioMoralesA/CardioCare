<div class="dashboard-container">

  <header class="dash-header">
    <div>
      <h1>Panel de Control MÃ©dico</h1>
      <p>MonitorizaciÃ³n Centralizada</p>
    </div>
    <button class="btn-builder" (click)="showBuilder = !showBuilder">
      {{ showBuilder ? 'Cancelar' : '+ Nuevo Monitor' }}
    </button>
  </header>

  <section *ngIf="showBuilder" class="builder-panel">
    <h3>Configurar Monitor</h3>
    <form [formGroup]="builderForm" (ngSubmit)="addWidget()" class="builder-form">

      <div class="form-group">
        <label>Paciente Objetivo</label>
        <select formControlName="patientId">
          <option value="" disabled>Seleccione...</option>
          <option *ngFor="let p of patientsList" [value]="p.id">
            {{ p.name }} (ID: {{p.id}})
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>MÃ©trica</label>
        <select formControlName="metric">
          <option *ngFor="let m of availableMetrics" [value]="m.value">{{ m.label }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>VisualizaciÃ³n</label>
        <select formControlName="type">
          <option *ngFor="let t of availableTypes" [value]="t.value">{{ t.label }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>Etiqueta / TÃ­tulo</label>
        <input type="text" formControlName="title" placeholder="Ej: Ritmo Juan">
      </div>

      <div class="form-group">
        <label>Color</label>
        <input type="color" formControlName="color" class="color-picker">
      </div>

      <button type="submit" [disabled]="builderForm.invalid" class="btn-add">Guardar</button>
    </form>
  </section>

  <div class="widgets-grid">
    <div *ngFor="let w of widgets" class="widget-card" [style.border-top-color]="w.parsedConfig?.color">

      <div class="widget-header">
        <div class="header-text">
          <h4>{{ w.parsedConfig?.title }}</h4>

          <span class="patient-badge">
            ðŸ‘¤ {{ w.parsedConfig?.targetPatientName || 'Paciente #' + w.parsedConfig?.targetPatientId }}
          </span>
        </div>

        <button (click)="deleteWidget(w.id)" class="btn-remove">Ã—</button>
      </div>

      <div class="widget-body" [ngSwitch]="w.parsedConfig?.type">

        <div *ngSwitchCase="'STAT_CARD'" class="stat-display">
          <span class="big-number" [style.color]="w.parsedConfig?.color">
            {{ getMetricValue(w.parsedConfig) }}
          </span>
          <small>Ãšltimo dato</small>
        </div>

        <div *ngSwitchCase="'BAR_CHART'" class="chart-container">
          <div class="bars-wrapper">
            <div *ngFor="let point of getMetricHistory(w.parsedConfig)"
                 class="bar-group"
                 title="{{ point.date }}: {{ point.value }}">
              <div class="bar"
                   [style.height.px]="point.value / 2"
                   [style.background-color]="w.parsedConfig?.color">
              </div>
              <span class="bar-label">{{ point.date | date:'dd' }}</span>
            </div>
          </div>
        </div>

        <div *ngSwitchCase="'PROGRESS_CIRCLE'" class="circle-display">
          <div class="progress-circle"
               [style.--p]="w.parsedConfig?.metric === 'ACTIVITY' ? getAdherence(w.parsedConfig) : 0"
               [style.--c]="w.parsedConfig?.color">
            <span>{{ w.parsedConfig?.metric === 'ACTIVITY' ? (getAdherence(w.parsedConfig) | number:'1.0-0') : 'N/A' }}%</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
