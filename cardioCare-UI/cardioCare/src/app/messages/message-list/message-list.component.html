<div class="messenger-container">

  <aside class="sidebar">
    <div class="sidebar-header">
      <h3>Mensajes</h3>
      <button class="btn-icon" (click)="showNewChatModal = true" title="Nuevo Chat">+</button>
    </div>

    <div class="thread-list">
      <div *ngFor="let thread of threads"
           class="thread-item"
           [class.active]="activeThread?.consultationId === thread.consultationId"
           (click)="selectThread(thread)">

        <div class="avatar">{{ thread.partnerId }}</div>

        <div class="thread-info">
          <div class="thread-meta">
            <strong>Usuario #{{ thread.partnerId }}</strong>
            <small>{{ thread.lastDate | date:'dd/MM' }}</small>
          </div>
          <p class="preview">
            <span class="cid-tag">#{{ thread.consultationId }}</span>
            {{ thread.lastMessage }}
          </p>
        </div>
      </div>

      <div *ngIf="threads.length === 0" class="empty-state">
        No hay conversaciones.
      </div>
    </div>
  </aside>

  <main class="chat-area">

    <div *ngIf="showNewChatModal" class="new-chat-wrapper">
      <h2>Iniciar Nueva Conversación</h2>
      <form [formGroup]="newChatForm" (ngSubmit)="startNewChat()" class="form-card">
        <div class="form-group">
          <label>ID Usuario Destino</label>
          <input type="number" formControlName="receiverId" placeholder="Ej: 5">
        </div>
        <div class="form-group">
          <label>ID Consulta (Referencia)</label>
          <input type="number" formControlName="consultationId" placeholder="Ej: 100">
        </div>
        <div class="form-group">
          <label>Mensaje Inicial</label>
          <textarea formControlName="content"></textarea>
        </div>
        <button type="submit" [disabled]="newChatForm.invalid" class="btn-primary">Enviar</button>
      </form>
    </div>

    <div *ngIf="!showNewChatModal && activeThread" class="chat-active">
      <div class="chat-header">
        <h4>Consulta #{{ activeThread.consultationId }}</h4>
        <span>Chat con Usuario #{{ activeThread.partnerId }}</span>
      </div>

      <div class="chat-history" id="chatHistory">
        <div *ngFor="let msg of activeThread.messages"
             class="msg-bubble"
             [ngClass]="{'sent': msg.senderId === currentUserId, 'received': msg.senderId !== currentUserId}">

          <div class="bubble-content">
            <p>{{ msg.content }}</p>
            <span class="time">{{ msg.sentAt | date:'HH:mm' }}</span>
          </div>
        </div>
      </div>

      <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="input-area">
        <input type="text" formControlName="content" placeholder="Escribe un mensaje..." autocomplete="off">
        <button type="submit" [disabled]="chatForm.invalid">➤</button>
      </form>
    </div>

    <div *ngIf="!showNewChatModal && !activeThread" class="welcome-screen">
      <div class="welcome-content">
        <h3>Selecciona un chat</h3>
        <p>para ver el historial o inicia uno nuevo.</p>
      </div>
    </div>

  </main>
</div>
